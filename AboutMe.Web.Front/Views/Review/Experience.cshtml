@model AboutMe.Domain.Entity.Review.ReviewExpListViewModel
@using AboutMe.Domain.Entity.Review
@using AboutMe.Common.Data
@using AboutMe.Common.Helper
@using AboutMe.Web.Front.Models
@using AboutMe.Web.Front.Controllers
@using System.Text.RegularExpressions
@{
    ViewBag.Title = "Review Experience";
    Layout = "~/Views/Shared/_AboutMeLayoutA.cshtml";
    var myController = ViewContext.Controller as ReviewController;
}

@section Head{
    @{ Html.RenderPartial("~/Views/AboutMePartial/_Head.cshtml");}
    <script src="/aboutCom/js/lib/masonry.pkgd.min.js" type="text/javascript"></script>
    <script src="/aboutCom/js/lib/imagesloaded.pkgd.min.js" type="text/javascript"></script>
    <link href="/aboutCom/css/review.css" rel="stylesheet" />

    <script>

    </script>


    <script type="text/javascript">


    var $grid;


    var img_path_product = "@myController._img_path_product";
    var img_path_review = "@myController._img_path_review";

    var categoryCode = "@CategoryCode.BEAUTY_DEFAULT";
    var sort = "@ReviewExpListViewModel.SORT_LASTEST";//최신순
    var tailIdx = @(Model.Reviews.Count > 0 ? Model.Reviews.Last().IDX : -1);

    console.log("tailIdx", tailIdx);

    // select category
    function selectCategoryMenu(cc) {
        if (categoryCode != cc) categoryCode = cc;
        tailIdx = undefined;
        removeAllItems();

        getReviewProducList();
    }

    //
    function sorting(s) {
        if (sort != s) sort = s;
        tailIdx = undefined;
        removeAllItems();
        getReviewProducList();
    }

    //더 보기
    function moreView() {
        getReviewProducList();
    }

    $(function () {
        initMasonry();
    });

    function initMasonry() {
        /**/
        // init Masonry
        $grid = $('#reviewConts').masonry({
            itemSelector: ".grid",
            transitionDuration: 0
        });
        // layout Masonry after each image loads
        $grid.imagesLoaded().progress(function () {
            $grid.masonry('layout');
        });

        /*
        //example  http://masonry.desandro.com/methods.html#appended

       */
    }
    function getReviewProducList() {
        console.log(tailIdx, categoryCode, sort);

        $.ajax({
            url: "@(Url.Action("GetReviewExpList", "Review"))",
            type: "POST",
            dataType: "json",
            data: {
                TAIL_IDX: tailIdx
                , CATEGORY_CODE: categoryCode
                , SORT: sort
            },
            success: function (data) {
                //alert(data.success);
                console.log(data);

                if (data.Success) {


                    addItems(data.Reviews);

                    $("#totalReview").text(data.Total);

                }
            },
            error: function (e) {
                console.log(e);
            }
        });
    }//end func

    function addItems(list) {
        if (list.length > 0) {
            //var $items = [];
            for (var i = 0 ; i < list.length ; ++i) {
                var item = list[i];


                var html = "<div class='grid' onclick='reviewpop_view()'>";

                //<!--제품 이름 및 정보-->
                html += "<div class='product_info'>";
                html += "    <div class='photo'><img src='"+img_path_product + item.P_MAIN_IMG+"' alt=''></div>";
                html += "    <div class='detail'>";
                html += "       <p class='tit'>"+item.P_NAME+"</p>";
                html += "       <p class='stit'>"+(item.P_SUB_TITLE != undefined ? item.P_SUB_TITLE : "")+"</p>";
                html += "    </div>";
                html += "</div>";

                // <!--리뷰-->
                html += "<div class='comments'>";
                html += "   <div class='idhit'>";
                html += "       <span class='id'>"+item.M_ID_LBL+"</span>";
                html += "       <span class='hit'>조회수 "+(item.VIEW_CNT != undefined ? item.VIEW_CNT : "0")+"</span>";
                html += "   </div>";

                html += "   <div class='writer'>";
                html += "       <span class='skin "+item.SKIN_TYPE_LBL+"'>"+item.SKIN_TYPE_CSS+"</span><em class='userage'>"+item.M_BIRTHDAY_LBL+"대, "+item.M_SEX_LBL+"</em>";
                html += "   </div>";
                html += "   <div class='tag'>";
                html +=         item.TAG;
                html += "   </div>";
                html += "   <div class='reviewtxt'>";
                html += "       <p class='title'>"+item.TITLE+"</p>";
                html += "       <p class='txt txtdotdot'>";
                /*
                var tmp_comment = item.COMMENT_TEXT;
                var rm_html = /<[^>]*>/g;
                var rm_etc = /&(nbsp|amp|quot|lt|gt);/g;
                tmp_comment = tmp_comment.replace(rm_html, "");
                tmp_comment = tmp_comment.replace(rm_etc, "");*/
                html +=             item.COMMENT_TEXT;

                html += "       </p>";

                if (item.SUB_IMG_1 != null)
                {
                    html += "<img src='"+ img_path_review +item.SUB_IMG_1+"' alt='' /><br />";
                }
                if (item.SUB_IMG_2 != null)
                {
                    html += "<img src='"+ img_path_review +item.SUB_IMG_2+"' alt='' /><br />";
                }

                html += "   </div>";
                html += "</div>";
                // <!--//리뷰-->

                html += "</div>";




                var elem = $(html);
                $grid.masonry().append(elem).masonry('appended', elem).masonry();
            }

           // console.log("d.IDX", d.IDX)

        //꼬리값 물기
            if (tailIdx != item.IDX) {
                tailIdx = item.IDX;
            }
        } else {
                alert("더 이상 결과값이 없습니다.");
        }
    }//end func

        function removeAllItems() {
            $(".grid").each(function () {
                $grid.masonry('remove', this)
            });
        }//end func

    </script>
}

@section Body{
    <div class="wrap review">
        <!--header-->
        @{ Html.RenderPartial("~/Views/AboutMePartial/_Header.cshtml");}
        <!--//header-->
        <!--container-->
        <div id="container">
            <div class="container1080">
                <div class="h_tit">
                    <h2><a href="@Url.Action("Product", "Review")">상품 리뷰</a></h2>
                    <h2 class="cnt">체험단 리뷰</h2>
                </div>

                <div class="selecttypeC">
                    <!--현재 소팅 대분류 class "on" 사용-->
                    <div class="sort">
                        <p class="tit"><a href="#">뷰티</a></p>
                        @if (Model.CategoryBeauty.Count > 0)
                        {
                            <ul>
                                <li><a href="#" onclick="selectCategoryMenu('@CategoryCode.BEAUTY_DEFAULT'); return false;">전체</a></li>
                                @foreach (var item in Model.CategoryBeauty)
                                {

                                    <li><a href="#" onclick="selectCategoryMenu('@item.CATE_CODE'); return false;">@item.DEPTH2_NAME</a></li>
                                }
                            </ul>
                        }
                    </div>
                    <div class="sort nolist">
                        <p class="tit">헬스</p>
                        <ul>
                            <li><a href="#" onclick="selectCategoryMenu('@CategoryCode.HEALTH_DEFAULT'); return false;">전체</a></li>
                        </ul>
                    </div>
                    <div class="sort">
                        <p class="tit">기타브랜드</p>
                        @if (Model.CategorySelShop.Count > 0)
                        {
                            <ul>
                                <li><a href="#" onclick="selectCategoryMenu('@CategoryCode.SEL_SHOP_DEFAULT'); return false;">전체</a></li>
                                @foreach (var item in Model.CategorySelShop)
                                {
                                    <li><a href="#" onclick="selectCategoryMenu('@item.CATE_CODE');return false;">@item.DEPTH2_NAME</a></li>
                                }
                            </ul>
                        }
                    </div>
                </div>

                <div class="reviewConts_area">
                    <span class="totaltxt">총 <strong id="totalReview">@Model.Total</strong>개의 상품이 있습니다.</span>
                    <!--sort-->
                    <div class="sort">
                        <ul>
                            <li class="cnt"><a href="#" onclick="sorting('@ReviewExpListViewModel.SORT_LASTEST');return false;">최신순</a></li>
                            <li><a href="#" onclick="sorting('@ReviewExpListViewModel.SORT_LIKE');return false;">인기순</a></li>
                            
                        </ul>
                    </div>
                    <!--//sort-->
                    <div id="reviewConts" class="bocksitls">

@foreach (var item in Model.Reviews)
{
                        <div class="grid" onclick="reviewpop_view()">
                            <!--제품 이름 및 정보-->
                            <div class="product_info">
                                <div class="photo"><img src="@myController._img_path_product@item.P_MAIN_IMG" alt=""></div>
                                <div class="detail">
                                    <p class="tit">@item.P_NAME</p>
                                    <p class="stit">@item.P_SUB_TITLE</p>
                                </div>
                            </div>
                            <!--//제품 이름 및 정보-->
                            <!--리뷰-->
                            <div class="comments">
                                <div class="idhit">
                                    <span class="id">@item.M_ID_LBL</span>
                                    <span class="hit">조회수 @(item.VIEW_CNT ?? 0)</span>
                                </div>
                                <div class="writer">
                                    <span class="skin @(item.SKIN_TYPE_LBL)">@(item.SKIN_TYPE_CSS)</span><em class="userage">@(item.M_BIRTHDAY_LBL)대, @(item.M_SEX_LBL)</em>
                                </div>
                                <div class="tag">
                                    @(item.TAG)
                                    <!--<span>#마사지</span> <span>#미백</span> <span>#촉촉</span>-->
                                </div>
                                <div class="reviewtxt">
                                    <p class="title">@item.TITLE</p>
                                    <p class="txt txtdotdot">
                                        @item.COMMENT_TEXT
                                        @{
                                            /*
                                           string textOnly = string.Empty;
                                            Regex tagRemove = new Regex(@"<[^>]*(>|$)");
                                            Regex compressSpaces = new Regex(@"[\s\r\n]+");
                                            Regex etc = new Regex(@"&(nbsp|amp|quot|lt|gt);");
                                            textOnly = tagRemove.Replace(item.COMMENT, string.Empty);
                                            textOnly = compressSpaces.Replace(textOnly, " ");
                                            textOnly = etc.Replace(textOnly, " ");
                                             */
                                        }
                                    
                                    </p>

                                    @if (item.SUB_IMG_1 != null)
                                    {
                                        <img src="@string.Format("{0}{1}", myController._img_path_review, item.SUB_IMG_1)" alt="" /><br />
                                    }
                                   
                                    @if (item.SUB_IMG_2 != null)
                                    {
                                        <img src="@string.Format("{0}{1}", myController._img_path_review, item.SUB_IMG_2)" alt="" /><br />
                                    }
                                    
                                </div>
                            </div>
                            <!--//리뷰-->
                        </div>
                       
}
                    </div>

                    <!--리뷰상세팝업-->
                    <div class="reviewpop_wrap">
                        <div class="dim"></div>
                        <div class="reviewpop">
                            <a href="#none" class="reviewpop_close" onclick="reviewpop_close()"><img src="/aboutCom/images/review/reviewpop_close.gif" alt="" /></a>
                            <!--reviewpop_top-->
                            <div class="reviewpop_top">
                                <div class="title_area">
                                    <p class="title">스킨 톤업 마사지 크림 완전 강추에요!</p>
                                    <div class="tag">
                                        <span>#마사지</span> <span>#촉촉</span> <span>#미백</span>
                                    </div>
                                </div>
                                <div class="writer">
                                    <div class="userinfo">
                                        <span class="skin normal">중성</span>
                                        <span class="age_gender">40대, 여</span>
                                    </div>
                                    <div class="right">
                                        <span class="id">kkon***</span>
                                        <span class="date">2015.06.06</span>
                                        <span class="hits">조회수 <em>253</em></span>
                                    </div>
                                </div>
                            </div>
                            <!--//reviewpop_top-->
                            <!--reviewpop_bottom-->
                            <div class="reviewpop_bottom">
                                <div class="reviewtxt">
                                    <p>
                                        어바웃미 스킨 톤업 마사지크림 리뷰입니다.<br />
                                        지금까지 여러 화장품을 써봤지만 이런 화장품은 처음이에요!
                                    </p>
                                    <img src="/aboutCom/images/review/thumb640.jpg" alt="" />
                                    <p>
                                        제품의 질감은 그냥 다른 마사지크림과 별다를게 없어요.
                                        그냥 상큼한 레몬향이 나는 정도? 그래서 이때만해도 이 마사지크림에 제가 이렇게 빠져들거라고는 생각을 못했어요ㅋㅋ
                                        그치만 크림을 얼굴에 바르고 마사지하는 순간 완전 신세계였어요!
                                    </p>
                                    <p>
                                        처음에는 그냥 크림으로 마사지하는거랑 별다를게 없었는데 어느순간 크림이 다 사라지고 약간 뻑뻑해지다가 오일로 마사지하는 것처럼 변해요!
                                        시간에 따라서 촉촉한 마사지크림-피부에 다 흡수되서 약간 뻑뻑한 느낌 -오일 마사지하는 것처럼 변하는게 너무 신기했어요
                                    </p>
                                    <img src="/aboutCom/images/review/thumb640.jpg" alt="" />
                                    <p>
                                        그리고 마사지를 다하고 화장솜으로 닦아내면 창피하지만 이렇게 노랗게 노폐물이 나옵니다ㅋㅋ
                                        사진이 너무 노골적이긴하지만 실제로 마사지하고 닦아내면 내 피부에 이렇게 노폐물이 많았나하고 놀라게되실거에요ㅋㅋ
                                        신기하기도하고 그동안 각질제거도 하고, 마스크팩이나 모델링팩으로 나름 피부관리를 한다고 생각했는데 이렇게 제 피부에 노폐물이 많을줄 몰랐어요.
                                        그래도 다행인건 요샌 스킨 톤업 마사지 크림을 사용하면서 처음보다 노폐물이 조금 나오고있어요.
                                        (색깔이 처음했을때랑 엄청 달라져요ㅋㅋ)
                                    </p>
                                    <p>
                                        그리고 의외로 용량도 많은 편이라서 가격대비 정말 좋은 마사지 크림인 것 같아요, 저는 지금 쓰는 제품 다 쓰면 재구매할 예정입니다
                                        완전 강추에용ㅋㅋ
                                    </p>
                                </div>
                                <div class="reviewproduct">
                                    <p class="title"><img src="/aboutCom/images/review/txt_review.gif" alt="리뷰상품" /></p>
                                    <div class="pro_info">
                                        <!--이미지사이즈 96x96-->
                                        <div class="photo"><img src="/aboutCom/images/sample/thum_cartpdt4.jpg" alt="" /></div>
                                        <div class="detail">
                                            <p class="tit">리얼 프레쉬팩 [로즈]</p>
                                            <p class="stit">맑고 촉촉한 피부를 위한 100%천연유래 <br />Real fresh pack</p>
                                            <p class="price">4,000원</p>
                                        </div>
                                    </div>
                                    <!--상품관련 기획전-->
                                    <div class="plbanr">
                                        <img src="/aboutCom/images/sample/thumb310140.png" alt="" />
                                    </div>
                                    <!--//상품관련 기획전-->
                                </div>
                            </div>
                            <!--//reviewpop_bottom-->
                        </div>
                    </div>
                    <!--//리뷰상세팝업-->

                </div>

                <a href="#" class="btn_more">더보기<i></i></a>

                <script type="text/javascript">
                    //리뷰팝업
                    function reviewpop_view() {
                        $("html").css({ "overflow-y": "hidden" });
                        $(".reviewpop_wrap").show();
                        $(".reviewpop_wrap").css({ "overflow-y": "auto" });
                    }
                    function reviewpop_close() {
                        $(".reviewpop_wrap").hide();
                        $(".reviewpop_wrap").css({ "overflow-y": "hidden" });
                        $("html").css({ "overflow-y": "auto" });
                    }
                </script>
            </div>
        </div>
        <!--//container-->

        <!--Footer-->
        @{ Html.RenderPartial("~/Views/AboutMePartial/_Footer.cshtml");}
        <!--//Footer-->

    </div>
    <!--//wrap-->
}

